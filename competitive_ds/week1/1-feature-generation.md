# Генерация новых признаков

## Зачем изучать Feature Engineering

> **Feature Engineering** — это набор методов, который помогает получать признаки, на которых модель при прочих данных выдает лучший результат.

![image-20240302122252073](/home/andrei/study/mipt_semester4/competitive_ds/week1/assets/image-20240302122252073.png)

Создание новых признаков начинаем с получения бизлайна на сырых данных с не очень сложной моделью. Мы фиксируем все параметры и добавляем новые признаки. По ходу добавления новых признаков обращаем внимание на скор, который генерирует модель, — чем лучше качество, которое показывает модель, тем полезнее добавленный признак.

Feature Engineering зависит от имеющихся у нас данных. Разберем подробнее, почему нужно погружаться в эту тему.

**Зачем изучать Feature Engineering:**

- **Только сырых данных недостаточно.** Добавление признаков может решить проблему. Например, классы становятся разделенными, потому что признак оказался полезным.
- **Высокая цена, если ML-модель извлекает закономерности сама.** Модель может получаться очень сложной, так как имеющиеся признаки не очень информативны.

![image-20240302122536778](/home/andrei/study/mipt_semester4/competitive_ds/week1/assets/image-20240302122536778.png)

Рассмотрим самые распространенные виды признаков.

## Виды признаков

### **Численные признаки**

Из неуникальных ID можно сгенерировать полезные признаки, например, с помощью группировок.

![image-20240302122707405](/home/andrei/study/mipt_semester4/competitive_ds/week1/assets/image-20240302122707405.png)

Если в численных или категориальных признаках есть пропуски, то это можно использовать как дополнительные признаки. Для этого заполняем пропуски не только средним, медианой или модой, но и опираясь на другие признаки.

### **Категориальные и порядковые признаки**

Порядковые признаки можно обрабатывать не только как категориальные, но и переводить их в численный вид, чтобы выполнять с ними математические операции.

![image-20240302122825732](/home/andrei/study/mipt_semester4/competitive_ds/week1/assets/image-20240302122825732.png)

**Что делать, если при работе с категориальными признаками встречаются редкие значения:**

- Схлопывать их в отдельную группу, например, -1.
- Схлопывать их в бины, чтобы сохранить больше информации. Количество бинов определяется качеством модели при изменении этого признака.

![image-20240302122928169](/home/andrei/study/mipt_semester4/competitive_ds/week1/assets/image-20240302122928169.png)

### **Время и временные ряды**

Часто в данных есть временные метки (time stamp). В зависимости от того, какую задачу мы решаем, из даты можем:

- Базово вытащить — год, месяц, день, час, минуты, секунды.
- Добавить в таблицу дополнительные характеристики, например, праздничный день или это выходной.

![image-20240302123005812](/home/andrei/study/mipt_semester4/competitive_ds/week1/assets/image-20240302123005812.png)

В данных может быть не только дата, но и другие временные метки:

- **временной ряд** — некоторая последовательность значений — статистики генерируются с помощью фреймворка tsfresh;
- **логи**, преобразовываются в признаки с помощью LifeStream.
- **частоты**, извлекаются с помощью преобразования Фурье.



> **Важно!** Когда мы работаем с временной шкалой, важно оставаться внимательным при разделении обучающей выборки на train-тест, чтобы не допустить заглядывания в будущее.

### **Тексты и последовательности**

Базовые статистики часто встречающихся элементов или последовательностей можно извлекать:

- из небольших последовательностей с помощью BoW или TF-iDF.
- из текстовых последовательностей с помощью нейронных сетей или BERT.

![image-20240302123110435](/home/andrei/study/mipt_semester4/competitive_ds/week1/assets/image-20240302123110435.png)

В обучающей выборке могут встретиться категории, которых нет в тесте:

![image-20240302123138444](/home/andrei/study/mipt_semester4/competitive_ds/week1/assets/image-20240302123138444.png)

**Что делать:**

1. Попытаться заменить отсутствующие группы численными фичами.
2. Сгенерировать с помощью `GroupBy` и пр. Например:

![image-20240302123219223](/home/andrei/study/mipt_semester4/competitive_ds/week1/assets/image-20240302123219223.png)

3. Выбросить категориальный столбец.

### **Геоданные**

В датасетах могут присутствовать геоданные в виде координат или полигонов. Первое, что можно сделать, — через GeoPandas извлечь с помощью координат центроиды и посчитать расстояния от каждой координаты до этих центроидов. Если мы работаем с полигонами, то добавляем как признаки пересечение полигонов или для каждой точки считаем самый популярный таргет в диапазоне этой границы.

Бывает полезно из имеющихся геоданных спарсить информацию по IP или через библиотеки (Meteostat, GeoPandas, GeoPy). Ниже указано подробнее, какую информацию в какой библиотеке можно найти:

![image-20240302123322049](/home/andrei/study/mipt_semester4/competitive_ds/week1/assets/image-20240302123322049.png)

### **Графовые данные**

Если получилось найти графовую структуру данных, то можно использовать библиотеки:

- NetworkX;
- Graph1Vec или Node2Vec;
- StellarGraph и т. д.

NetworkX — самая популярная библиотека. Из нее можно получить следующие признаки:

- PageRank;
- Degree_centrality;
- Closeness_centrality;
- Betweenness_centrality и т. д.

![image-20240302123636684](/home/andrei/study/mipt_semester4/competitive_ds/week1/assets/image-20240302123636684.png)

Графовую структуру можно обогатить с помощью других имеющихся признаков. Например, превратить в взвешенный граф, где для ребер будут присутствовать веса:

![image-20240302123703789](/home/andrei/study/mipt_semester4/competitive_ds/week1/assets/image-20240302123703789.png)

У данных может не быть графовой структуры, но эту структуру мы можем создать сами с помощью K-NN:

![image-20240302123734088](/home/andrei/study/mipt_semester4/competitive_ds/week1/assets/image-20240302123734088.png)

### Соберем все перечисленные признаки в одном месте:

![image-20240302123800942](/home/andrei/study/mipt_semester4/competitive_ds/week1/assets/image-20240302123800942.png)

На самом деле, подходов, которые мы можем использовать на практике, намного больше, чем мы разобрали на занятии. Призываем вас экспериментировать и выходить за рамки тех данных, что предлагается изначально.

## Выводы

- Начните с бейзлайна на сырых данных. Цель — извлечь из данных всю информацию.
- Проверяйте эффект от новых признаков как можно чаще.
- Gold features поднимают скор сильнее тюнинга ML-моделей.
- Чем больше неcкоррелированных признаков, тем лучше.
- Визуализация поможет найти киллер-фичи быстрее.
- Признаки бывают вредные.

# **Feature Engineering**